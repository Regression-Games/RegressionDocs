---
sidebar_label: 'Recording Gameplay'
---

import Accordion from "../../src/components/Accordion"

# Recording Gameplay

The [RGOverlayCanvas](../getting-started/installing-regression-games#add-the-regression-games-overlay-to-your-scene)
allows you to record game state and user inputs as you play through your game.
This information can be used to [automatically replay the scenario](#replaying-recordings),
validate game behaviour with [Validation Suites](./validation-suites),
and form the basis of complex [Bot Sequences](./bot-sequences/getting-started-with-bot-sequences-and-segments).

At a high level, the SDK captures the following information during gameplay:
* Entities and their state (e.g. position, behaviours, colliders)
* Performance information (e.g. frame rate, memory usage)
* User input (e.g. keyboard, mouse, gamepad)
* Screenshots

The SDK captures this information once every **tick**.
A tick is a snapshot of the game state at a given point in time.
One or more frames may elapse between two ticks, depending on the configured [tick interval](#tick-interval).
Ticks are important to understand when working with the SDK, as they are used to visualize changes in the game state over time.

## Creating a Recording

:::info
Recording requires the [RGOverlayCanvas](../getting-started/installing-regression-games#add-the-regression-games-overlay-to-your-scene)
to be present in your scene.
:::

Press the **Record** icon in the RG Toolbar while in "Play" mode to start recording gameplay.
The icon will pulse to signal that a recording is in progress, and our SDK will begin capturing game state and user inputs.

![Start Recording](img/recording-gameplay/start-recording.png)


Click the **Record** icon again to stop the recording and save captured data to your local device.
If you have provided a valid [API Key in the RG Settings](../getting-started/installing-regression-games#configure-your-api-key),
then a copy of the captured data will also be uploaded to your Regression Games account as a [Gameplay Session](gameplay-sessions).
Gameplay Sessions unlock access to more features through the Regression Games web interface such as [Validation Suites](validation-suites).

## Replaying Recordings

Replaying a recording reproduces each tick in the original recording in order.
This involves simulating the inputs from the original recording, and waiting for key values in the game state to match expectations for that tick
before continuing to the next set of inputs in the recording.
The SDK records the state of the game while a replay is in progress, and saves the replay data as a new recording and Gameplay Session.
Replay, and recording the replay, can be useful for identifying areas of your game that behave inconsistently
given the same inputs, reproducing transient bugs and collecting information for debugging them,
or ensuring that changes to your game don't affect unintended behaviours.

:::tip
Replaying a recording file works best in deterministic or mostly-deterministic scenarios.
For example, navigating menus tends to be deterministic, while the locations and movements of NPCs may not be.
The replay tool attempts to account for some inconsistencies, but it is not perfect.
For games with a high degree of randomness or non-determinism, we recommend using recordings as a basis to
create your own customized [Bot Sequences](bot-sequences/getting-started-with-bot-sequences-and-segments)
rather than relying on raw recordings themselves.
:::

### Starting a Replay

There are two ways to initiate a replay of an existing recording:
manually select a recording via the overlay, or programmatically start a recording using utilities from our SDK.

### Manual Replay

import ReplayOptions from "./img/recording-gameplay/replay-options.png"
import SuccessfulReplay from "./img/recording-gameplay/successful-replay.png"
import LoopCounter from "./img/recording-gameplay/loop-counter.png"

Press the **Menu** icon in the RG Toolbar while in "Play" mode to select a recording to replay.
This will launch a file explorer at the location of the [recordings directory](#recording-directory) on your device.
Navigate into the folder of the recording you'd like to replay, select its `bot_segments.zip` file, and then click **Load Replay**.

![Select a Recording](img/recording-gameplay/select-recording.png)

<div className="container row text--center">
<figure className="col">
    <img src={ReplayOptions} alt="Replay Options"/>
    <figcaption>
        You can <b>Play</b> the recording once or <b>Loop</b> it to play continuously.
        The <b>Stop</b> button stops and unloads the current recording.
        Stopping a recording in the middle of playback will save the replay up to that point.
    </figcaption>
</figure>

<figure className="col">
    <img src={SuccessfulReplay} alt="Successful Replay"/>
    <figcaption>
        Successful playback results in a green indicator surrounding the <b>Play</b> icon.
        The recording can be played again or unloaded.
    </figcaption>
</figure>

<figure className="col">
    <img src={LoopCounter} alt="Loop Counter"/>
    <figcaption>
        Looping the recording displays a counter for the current loop iteration.
        Looping works best when the recording returns itself to a known start state
        to set up the next loop iteration.
    </figcaption>
</figure>
</div>

#### Programmatic Replay

The `RGTestUtils` class provides methods for replaying recordings programmatically.
This is intended for use in
[Play Mode tests for the Unity Test Runner](https://docs.unity3d.com/Packages/com.unity.test-framework@1.4/manual/index.html).

:::info
The `RegressionGames` and `RegressionGames.TestFramework` assemblies must be listed as
references in your test assembly to use the `RGTestUtils` class.

![Test assembly references for Regression Games SDK](img/recording-gameplay/test_assembly_refs.png)
:::

:::tip
By default, [recordings are saved outside your project](#recorded-data-formats).
Make sure you copy the recordings you'd like to replay into your project
to ensure they'll be available on other machines that run these automated tests.
:::

Create a `UnityTest` that invokes the `RGTestUtils.StartPlaybackFromZipFile` method.
Pass the path to your recording's `bot_segments.zip` file.
This will replay the recording, wait until playback is complete, and then save the replay as a new recording.
You can add additional logic to your test to validate the game state at the end of playback,
or use a recording to reach a known state in your game for further testing.

```csharp
using System.Collections;
using RegressionGames;
using RegressionGames.Types;
using UnityEngine.Assertions;
using UnityEngine.SceneManagement;
using UnityEngine.TestTools;

public class RecordingTest
{

    [UnityTest]
    public IEnumerator TestRecording()
    {

        // Unity has a macOS bug that prints errors when taking screenshots during recording.
        // This line prevents the test from failing when these errors are logged.
#if UNITY_EDITOR_OSX || UNITY_RUNTIME_OSX
        LogAssert.ignoreFailingMessages = true;
#endif

        // Define which recording to use
        string recordingPath = System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "Assets/Tests/Runtime/Recordings/MainMenuRecording.zip");

        // Wait for the scene to load
        SceneManager.LoadSceneAsync("Startup", LoadSceneMode.Single);
        yield return RGTestUtils.WaitForScene("MainMenu");

        // Start playback
        // This will automatically create a new recording of the replay
        PlaybackResult playbackResult = null;
        yield return RGTestUtils.StartPlaybackFromZipFile(recordingPath, result => playbackResult = result);

        // Print out the recording path for viewing later
        RGDebug.LogInfo("Played back and recorded the test run - saved to " + playbackResult.saveLocation);
        Assert.IsNotNull(playbackResult.saveLocation);

    }
}
```

### Game State Errors During Replay

The replay tool attempts to reproduce each tick in the original recording in order.
This involves simulating the original user inputs, and waiting for key values in the game state to match expectations for that tick.
If the game state does not match a set of key expectations set by the original recording after a certain timeout,
then the replay will pause itself and display a warning above the RG Toolbar with the list of unmet expectations.
Replay will continue from where it left off if the warning is resolved.

TODO: get new screenshot of replay error

![Errors During Playback](gameplay-sessions/img/overlay_playback_error.png)


## Recorded Data Formats

By default, the SDK saves recordings to your user's home directory under `unity_videos`.
[This directory is configurable](#recording-directory).
The SDK gives each Unity project its own directory matching the project's `Application.productName`.
A recording is saved under its project directory as a folder named `recording_{MM-dd-yyyy_HH.mm}_{sessionId}`.

For example, a recording for a project named "MyGame" may be located at:
```bash
# macOS & Linux
~/unity_videos/MyGame/recording_08-30-2024_14.34_0b8551

# Windows
C:\Users\{MyUser}\unity_videos\MyGame\recording_08-30-2024_14.34_0b8551
```

A recording folder contains multiple files that provide important context about the game's state.
All of this same data is saved to the [Gameplay Session](gameplay-sessions) that is uploaded
to your Regression Games account at the end of a recording.
Expand the sections below to learn more about our raw data formats.

import BotSegmentsZipPartial from "../partials/recording-gameplay/_bot-segments-zip-partial"
import DataZipPartial from "../partials/recording-gameplay/_data-zip-partial"
import LogsZipPartial from "../partials/recording-gameplay/_logs-zip-partial"
import ScreenshotsZipPartial from "../partials/recording-gameplay/_screenshots-zip-partial"
import ThumbnailJpgPartial from "../partials/recording-gameplay/_thumbnail-jpg-partial"

<Accordion
    title="#### **bot_segments.zip**"
    content={BotSegmentsZipPartial}
/>

<Accordion
    title="#### **data.zip**"
    content={DataZipPartial}
/>

<Accordion
    title="#### **logs.zip**"
    content={LogsZipPartial}
/>

<Accordion
    title="#### **screenshots.zip**"
    content={ScreenshotsZipPartial}
/>

<Accordion
    title="#### **thumbnail.jpg**"
    content={ThumbnailJpgPartial}
/>


## Advanced Configuration

### Tick Interval

The `Recording Min FPS` field under `RGOverlayCanvas` > `ScreenRecorder` allows you to configure
how often the SDK scrapes the game for state data.
Its default value is 0, which instructs the SDK to only record state data when it detects a
[**key frame**](./gameplay-sessions-reference#key-frames). In most cases, this should be set to 0, as most games will only require state collection on key frames.
Setting `Recording Min FPS` to a value greater than 0 will cause the SDK to record data at that frequency,
in addition to recording any key frame that was detected.
For instance, a setting of `5` will result in the SDK scraping the game for state data 5 times per second.

![Change the FPS at which data is collected from the game](gameplay-sessions/img/base_options_fps.png)

### Recording Directory

By default, recorded data is stored in your home directory under `/unity_videos`.
This directory can be overridden by changing the `State Recordings Directory` field under `RGOverlayCanvas` > `ScreenRecorder`.

![Change the location where data is saved](gameplay-sessions/img/base_options_location.png)

### Input threshold options

Some devices might recognize holding down a key as spamming key presses for that key instead.
The `Key Held Threshold Seconds` field under `RGOverlayCanvas` > `Keyboard Input Action Observer`
allows you to configure the threshold for how long a key must be released
between presses before each press is considered a distinct event.
This setting defaults to 0.1 seconds, and on Windows should not have to be changed. This setting is primarily used on
Mac and other platforms that handle key repeats in a non-standard way.  If you do experience key click spamming,
increase the value.

![Change the threshold for held key inputs](gameplay-sessions/img/base_options_threshold.png)

### Configuring game-state collection

The Regression Games SDK scrapes the game for state data by traversing the game's GameObject hierarchy
and recording any data it considers relevant to playing back recordings or running tests.

#### Excluding GameObjects from Data Capture

Adding the `RGExcludeFromState` component to a GameObject will prevent its state data from being recorded.
This can be useful for ignoring irrelevant regions of a level
or other objects that are not relevant to your playback or testing.
Children of an excluded GameObject are also excluded from the recording, effectively ignoring the entire hierarchy.

#### Including objects from your scene in the state

By default, the system records game objects visible in the scene with a renderer. Other game objects can be included in
the state by attaching the `RGIncludeInState` MonoBehaviour to them.

#### Collapsing renderers

By default, the SDK collapses a child GameObject's data into its respective top-level GameObject.
If a GameObject hierarchy has colliders/renderers/animators/etc. at multiple levels,
they will be represented together as a single "entity" in the recorded state.
This is generally desirable, as it allows you to treat each player (for example) as a complete entity in the state
rather than visualizing individual child components as their own entities.

However, it can also be useful to disable this behaviour in cases where you'd like to validate
render bounds on individual armatures, weapons, or other components that are children in the hierarchy.

The `Collapse Renderers into Top Level Game Object` checkbox under `RGOverlayCanvas` > `In Game Object Finder`
controls this behaviour, where checking the box forces collapsing and unchecking the box disables collapsing.

#### Include off-camera objects

By default, the SDK only records state data for GameObjects that are within the main camera's viewport.
In many cases, this is desirable because off-camera GameObjects are not relevant to playback or applicable test scenarios.
Off-camera objects can be included in recordings by toggling the
`Include Only On Camera Objects` checkbox under `RGOverlayCanvas` > `In Game Object Finder`.
Checking this box limits state collection to on-camera objects and unchecking the box enables state collection for
off-camera objects.

:::info Note

Recording objects outside the camera viewport may increase the size of recordings and impact performance.

:::

#### Collect state from behaviours

By default, the SDK only records state data from GameObjects themselves, and does not record
fields or property values from attached Behaviours.
These are generally not needed for playing back recordings, but can be extremely useful for test scenarios.

The `Collect State from Behaviours` checkbox under `RGOverlayCanvas` > `In Game Object Finder`
dictates whether recordings include data from Behaviours attached to a GameObject.
Checking this box will include all fields and properties from all Behaviours attached to a GameObject in the recorded state,
and unchecking the box will exclude them.

:::info Note

Recording state from Behaviours may incur an impact on performance.

:::

![Various options for scraping game objects from the scene](gameplay-sessions/img/base_options_finder.png)

